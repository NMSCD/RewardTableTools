const outputs={rewardList:getOutput("rewardList"),chancesInputType:getOutput("chancesInputType"),chancesTable:getOutput("chancesTable"),EXML:getOutput("EXML")};let file,ID,fileXmlDoc,snippetXmlDoc;function getOutput(e){return document.getElementById(e)}function updateVar(e){ID=e.value,searchReward(fileXmlDoc)}function readSingleFile(e){if(file=e.files.item(0),!file)return;const t=new FileReader;t.onload=function(e){const t=e.target.result;t&&(fileXmlDoc=processEXML(t),searchReward(fileXmlDoc),document.getElementById("rewardInput").value&&searchRewardSection(document.getElementById("rewardInput"),"chancesTable","EXML"))},t.readAsText(file)}function processEXML(e){return(new DOMParser).parseFromString(e,"text/xml")}function searchRewardSection(e,t,r){const n=fileXmlDoc;if(!n)return;const a=e.value,c=n.querySelector(`[value="GcGenericRewardTableEntry.xml"] > [name="Id"][value=${a} i], [value="GcRewardTableEntry.xml"] > [name="Id"][value=${a} i]`)?.parentNode;c&&(rewardChances(c,t,"Reward ID chances",n),SerialiseXML(c,r))}function searchReward(e){if(!file||!ID)return;const t=Array.from(e.querySelectorAll(`*:not([name="InventoryClass"])[value="${ID}" i]`));if(!t.length)return;const r=new Set;for(const e of t){const t=e.closest('[value="GcGenericRewardTableEntry.xml"], [value="GcRewardTableEntry.xml"]')?.querySelector('[name="Id"]');if(!t)return;r.add(t)}document.getElementById("rewardList").innerHTML="";for(const e of r){const t=`<li>${e.getAttribute("value")}</li>`;document.getElementById("rewardList").insertAdjacentHTML("beforeend",t)}}function rewardChances(e,t,r,n){if(!n)return;let a;if(e.parentNode?.querySelector('[value="GcRewardTableEntry.xml"]')||e.querySelector('[value="GcRewardTableEntry.xml"]')){const r=Array.from(e.querySelector('[name="Rarities"]').children),n=new Array;for(const e of r){const r=Array.from(e.querySelector('[name="Sizes"]').children),a=`<div class="rarity">${e.getAttribute("name")}</div>`;n.push(a);for(const e of r){const r=e.getAttribute("name"),a=getRewards(e);if(!checkDataIntegrity(a,t))return;if(0==a.IDs.length)continue;const c=`<div class="size">${r}</div>`,o=buildTable(a);n.push(c),n.push(o)}}a=n.join("")}else{const r=getRewards(e);if(!checkDataIntegrity(r,t))return;a=buildTable(r)}document.getElementById(t).innerHTML=a,document.getElementById("chancesInputType").innerText=r}function SerialiseXML(e,t){const r=(new XMLSerializer).serializeToString(e);document.getElementById(t).innerText=r}function searchSnippet(e,t){const r=e.value;r&&(snippetXmlDoc=processEXML(r),rewardChances(snippetXmlDoc,t,"Chances from EXML snippet",snippetXmlDoc))}function reset(){const e=document.querySelectorAll('input[type="text"], textarea');for(const t of e)t.value="";const t=document.querySelectorAll("#output [id]");for(const e of t)e.innerHTML=""}function buildTable(e){const t=new Array;for(let r=0;r<e.IDs.length;r++){const n=e.IDs[r],a=e.chances[r],c=e.rewards[r],o=n.toLowerCase()==ID?.toLowerCase()?`<mark>${r+1}.</mark><mark>${c}</mark><mark>${n}</mark><mark>${a}%</mark>`:`<div>${r+1}.</div><div>${c}</div><div>${n}</div><div>${a}%</div>`;t.push(o)}return t.join("")}function getRewards(e){const t=Array.from(e.querySelectorAll('[value="GcRewardTableItem.xml"]')),r=[],n=[],a=[],c=["ID","ProductList","Items","ProductIds","TechList","Currency","ProceduralProductCategory","Group","TechId","Event","Stat","CreatureID","ProductID","Reward"];for(const e of t){let t,o;for(const r of c)if(e.querySelector(`[name="${r}"]`)){t=r;break}switch(t){case"ID":case"TechId":case"Event":case"Reward":o=e.querySelector(`[name="${t}"]`).getAttribute("value");break;case"Items":case"ProductIds":case"ProductList":case"TechList":o=`List (${e.querySelector(`[name="${t}"]`).childElementCount} entries)`;break;case"ProceduralProductCategory":o=`ProcProd: ${e.querySelector(`[name="${t}"]`).getAttribute("value")}`;break;case"Group":o=`ProcTech: ${e.querySelector(`[name="${t}"]`).getAttribute("value")}`;break;case"CreatureID":o=`CreatureEgg: ${e.querySelector(`[name="${t}"]`).getAttribute("value")}`;break;case"ProductID":o=`SeasonReward: ${e.querySelector(`[name="${t}"]`).getAttribute("value")}`;break;case"Currency":o=e.querySelectorAll(`[name="${t}"]`)[1].getAttribute("value");break;case"Stat":o=`${e.querySelectorAll('[name="ModifyType"]')[1].getAttribute("value")} stat: ${e.querySelector(`[name="${t}"]`).getAttribute("value")}`;break;default:o="Error"}r.push(o);const u=e.querySelector('[name="PercentageChance"]');u?n.push(u.getAttribute("value")):n.push("Error");const l=e.querySelector('[name="Reward"]');l?a.push(l.getAttribute("value")):a.push("Error")}return constructData(e,r,n,a)}function constructData(e,t,r,n){return{IDs:t,chances:calculateChances(e,r),rewards:n}}function calculateChances(e,t){const r=t.map(Number);if("GiveAll"==e.querySelector('[name="RewardChoice"]')?.getAttribute("value"))return r;const n=new Array;for(const e of r){const t=e/(r.reduce(((e,t)=>e+t),0)/100);n.push(t.toFixed(3))}return n}function checkDataIntegrity(e,t){if(e.IDs.length===e.chances.length&&e.IDs.length===e.rewards.length)return!0;{console.log("ERROR"),document.getElementById(t).style.display="block";const e="<button class=\"button\" onclick=\"this.parentElement.style.display = ''; this.parentElement.innerHTML = '';\">Restore Functionality</button>";return document.getElementById(t).innerHTML="[ERROR: Array length doesn't match] Something went wrong. Please send the Reward Id to Lenni#4423 on Discord. Click this button to regain page functionality."+e,!1}}
